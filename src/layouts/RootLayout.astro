---
import "@fontsource/maple-mono/400.css";
import "@fontsource/maple-mono/500.css";
import "@fontsource/maple-mono/700.css";
import "@/styles/globals.css";
import BackToTop from "@/components/common/back-to-top.tsx";
import { ClientRouter } from 'astro:transitions';
const {title, maxWidth = "max-w-[640px]"} = Astro.props;
---


<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" type="image/svg+xml" href="/favicon.ico"/>
    <meta name="viewport" content="width=device-width"/>
    <meta name="generator" content={Astro.generator}/>
    <title>{title}</title>
    <ClientRouter />
    <script is:inline>
        // Immediately apply theme on page load (blocking, runs before anything renders)
        (function() {
            const theme = localStorage.getItem("theme") ||
                (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
            if (theme === "dark") {
                document.documentElement.classList.add("dark");
            }
        })();

        // MutationObserver to persist theme changes to localStorage
        if (typeof localStorage !== "undefined") {
            const observer = new MutationObserver(() => {
                const isDark = document.documentElement.classList.contains("dark");
                localStorage.setItem("theme", isDark ? "dark" : "light");
            });
            observer.observe(document.documentElement, {attributes: true, attributeFilter: ["class"]});
        }
    </script>

    <!-- View Transitions theme sync -->
    <script is:inline>
        // BEFORE swap: copy dark class to the incoming document
        document.addEventListener('astro:before-swap', (event) => {
            const isDark = document.documentElement.classList.contains('dark');
            event.newDocument.documentElement.classList.toggle('dark', isDark);
        });

        // AFTER swap: fallback to ensure theme is correct
        document.addEventListener('astro:after-swap', () => {
            const theme = localStorage.getItem("theme") ||
                (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
            document.documentElement.classList.toggle("dark", theme === "dark");
        });
    </script>
</head>
<body>
<main class={`min-h-svh mx-auto w-full flex flex-col font-sans px-6 py-8 ${maxWidth}`}>
    <slot/>
</main>
<BackToTop client:load/>
<!-- Add this portal container for dialogs -->
<div id="dialog-portal"></div>
</body>
</html>