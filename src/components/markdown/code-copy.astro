<script>
    const COPY_BUTTON_CLASS = "absolute right-2 top-2 p-2 rounded-md bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-all backdrop-blur-sm z-10";
    const CHECK_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
    const COPY_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;

    function processPreBlock(pre) {
        // Prevent duplicates
        if (pre.querySelector('.copy-code-btn')) return;

        // Position relative for button absolute placement
        if (getComputedStyle(pre).position === 'static') {
            pre.style.position = 'relative';
        }
        pre.classList.add('group');

        const button = document.createElement('button');
        button.className = `copy-code-btn ${COPY_BUTTON_CLASS}`;
        button.innerHTML = COPY_ICON;
        button.setAttribute('aria-label', 'Copy code');

        // Prevent button from being part of text selection
        button.style.userSelect = 'none';

        button.addEventListener('click', async (e) => {
            // Prevent triggering other click events
            e.stopPropagation();

            const code = pre.querySelector('code');
            const text = code?.innerText || pre.innerText;

            try {
                await navigator.clipboard.writeText(text);
                button.innerHTML = CHECK_ICON;
                button.classList.add('text-green-500', 'bg-muted');

                setTimeout(() => {
                    button.innerHTML = COPY_ICON;
                    button.classList.remove('text-green-500', 'bg-muted');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy code:', err);
            }
        });

        pre.appendChild(button);
    }

    // Observer to watch for new pre blocks
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1) { // Element node
                    if (node.tagName === 'PRE') {
                        processPreBlock(node);
                    } else if (node.querySelectorAll) {
                        node.querySelectorAll('pre').forEach(processPreBlock);
                    }
                }
            });
        });
    });

    function init() {
        // Process existing blocks
        document.querySelectorAll('pre').forEach(processPreBlock);

        // Start observing document body for changes (navigation, hydration, etc)
        observer.observe(document.body, { childList: true, subtree: true });
    }

    // Run on initial load
    init();

    // Re-run on view transitions to re-attach observer to new body
    document.addEventListener('astro:after-swap', () => {
        init();
    });
</script>
